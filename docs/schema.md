-- TABLE CREATION
CREATE TABLE profiles (
  id int8 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id uuid DEFAULT auth.uid() NOT NULL UNIQUE,
  name text,
  email text,
  bio text,
  skills_offered text,
  skills_wanted text,
  avatar_url text,
  created_at timestamptz DEFAULT now()
);

-- RLS POLICIES
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public profiles are viewable by everyone" 
ON profiles FOR SELECT USING (true);

CREATE POLICY "Users can update own profile" 
ON profiles FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own profile" 
ON profiles FOR INSERT WITH CHECK (auth.uid() = user_id);



-- TABLE CREATION
CREATE TABLE skills (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE,
  title text NOT NULL,
  description text,
  created_at timestamptz DEFAULT now()
);

-- RLS POLICIES
ALTER TABLE skills ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Skills are viewable by everyone" 
ON skills FOR SELECT USING (true);

CREATE POLICY "Users can manage own skills" 
ON skills FOR ALL USING (auth.uid() = user_id);


-- TABLE CREATION
CREATE TABLE requests (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  skill_id uuid REFERENCES skills(id) ON DELETE CASCADE,
  sender_id uuid REFERENCES auth.users(id),
  receiver_id uuid REFERENCES auth.users(id),
  status text DEFAULT 'pending',
  requester_id uuid, 
  created_at timestamptz DEFAULT now()
);

-- RLS POLICIES
ALTER TABLE requests ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Participants can view their requests" 
ON requests FOR SELECT USING (auth.uid() = sender_id OR auth.uid() = receiver_id);

CREATE POLICY "Users can create requests" 
ON requests FOR INSERT WITH CHECK (auth.uid() = sender_id);


-- TABLE CREATION
CREATE TABLE messages (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  request_id uuid REFERENCES requests(id) ON DELETE CASCADE,
  sender_id uuid REFERENCES auth.users(id),
  content text,
  created_at timestamptz DEFAULT now()
);

-- RLS POLICIES
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Participants can view their messages" 
ON messages FOR SELECT USING (
  request_id IN (
    SELECT id FROM requests WHERE sender_id = auth.uid() OR receiver_id = auth.uid()
  )
);

CREATE POLICY "Participants can send messages" 
ON messages FOR INSERT WITH CHECK (auth.uid() = sender_id);


-- TABLE CREATION
CREATE TABLE sessions (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  title text NOT NULL,
  description text,
  scheduled_at timestamptz NOT NULL,
  duration_minutes int4 DEFAULT 60,
  meeting_link text,
  host_id uuid REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at timestamptz DEFAULT now()
);

-- RLS POLICIES
ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Hosts can manage their sessions" 
ON sessions FOR ALL USING (auth.uid() = host_id);

CREATE POLICY "Participants can view sessions" 
ON sessions FOR SELECT USING (true); -- Allow involved parties to see the link



-- TABLE CREATION
CREATE TABLE resources (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE,
  title text NOT NULL,
  url text NOT NULL,
  resource_type text DEFAULT 'article',
  visibility text DEFAULT 'public',
  created_at timestamptz DEFAULT timezone('utc'::text, now())
);

-- RLS POLICIES
ALTER TABLE resources ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public resources are viewable by everyone" 
ON resources FOR SELECT USING (visibility = 'public' OR auth.uid() = user_id);

CREATE POLICY "Users can manage own resources" 
ON resources FOR ALL USING (auth.uid() = user_id);


-- TABLE CREATION
CREATE TABLE reviews (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  teacher_id uuid REFERENCES auth.users(id),
  student_id uuid REFERENCES auth.users(id),
  rating int4 CHECK (rating >= 1 AND rating <= 5),
  comment text,
  created_at timestamptz DEFAULT timezone('utc'::text, now())
);

-- RLS POLICIES
ALTER TABLE reviews ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Reviews are public" 
ON reviews FOR SELECT USING (true);

CREATE POLICY "Students can post reviews" 
ON reviews FOR INSERT WITH CHECK (auth.uid() = student_id);